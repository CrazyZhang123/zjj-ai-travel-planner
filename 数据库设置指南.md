# Supabase æ•°æ®åº“è®¾ç½®å®Œæ•´æŒ‡å—

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1: è®¿é—® Supabase SQL Editor

1. ç™»å½• https://supabase.com
2. é€‰æ‹©ä½ çš„é¡¹ç›®
3. ç‚¹å‡»å·¦ä¾§èœå• **SQL Editor**
4. ç‚¹å‡» **New Query** åˆ›å»ºæ–°æŸ¥è¯¢

### æ­¥éª¤ 2: æ‰§è¡Œæ•°æ®åº“è®¾ç½®è„šæœ¬

**æ¨èæ–¹å¼**ï¼šä½¿ç”¨é¡¹ç›®æä¾›çš„å®Œæ•´è„šæœ¬

1. æ‰“å¼€é¡¹ç›®æ ¹ç›®å½•çš„ `supabase-setup.sql` æ–‡ä»¶
2. **å…¨é€‰å¹¶å¤åˆ¶**æ‰€æœ‰å†…å®¹ï¼ˆCtrl+A, Ctrl+Cï¼‰
3. åœ¨ Supabase SQL Editor ä¸­ç²˜è´´
4. ç‚¹å‡»å³ä¸Šè§’ **Run** æŒ‰é’®ï¼ˆæˆ–æŒ‰ Ctrl+Enterï¼‰
5. ç­‰å¾…æ‰§è¡Œå®Œæˆï¼Œåº”è¯¥çœ‹åˆ° "Success. No rows returned"

### æ­¥éª¤ 3: éªŒè¯è®¾ç½®

#### éªŒè¯è¡¨ç»“æ„

åœ¨ SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'itineraries'
ORDER BY ordinal_position;
```

åº”è¯¥çœ‹åˆ°ä»¥ä¸‹åˆ—ï¼š
- `id` (uuid)
- `user_id` (uuid)
- `created_at` (timestamp with time zone)
- `updated_at` (timestamp with time zone)
- `title` (text)
- `payload` (jsonb)

#### éªŒè¯ RLS ç­–ç•¥

åœ¨ SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
SELECT schemaname, tablename, policyname, cmd 
FROM pg_policies 
WHERE tablename = 'itineraries';
```

åº”è¯¥çœ‹åˆ° 4 ä¸ªç­–ç•¥ï¼š
- `Users can view their own itineraries` (SELECT)
- `Users can insert their own itineraries` (INSERT)
- `Users can update their own itineraries` (UPDATE)
- `Users can delete their own itineraries` (DELETE)

#### éªŒè¯è¡¨æ˜¯å¦å­˜åœ¨

åœ¨ Supabase æ§åˆ¶å°ï¼š
1. ç‚¹å‡»å·¦ä¾§èœå• **Table Editor**
2. åº”è¯¥èƒ½çœ‹åˆ° `itineraries` è¡¨
3. ç‚¹å‡»è¡¨åï¼ŒæŸ¥çœ‹è¡¨ç»“æ„

---

## ğŸ”§ å¦‚æœé‡åˆ°é”™è¯¯

### é”™è¯¯ 1: "relation already exists"

**åŸå› **ï¼šè¡¨å·²ç»å­˜åœ¨

**è§£å†³**ï¼š
```sql
-- å…ˆåˆ é™¤æ—§è¡¨
DROP TABLE IF EXISTS itineraries CASCADE;

-- ç„¶åé‡æ–°æ‰§è¡Œ supabase-setup.sql
```

### é”™è¯¯ 2: "permission denied"

**åŸå› **ï¼šæ²¡æœ‰è¶³å¤Ÿçš„æƒé™

**è§£å†³**ï¼š
- ç¡®ä¿ä½ ä½¿ç”¨çš„æ˜¯é¡¹ç›® Owner è´¦å·
- æˆ–è€…è”ç³»é¡¹ç›®ç®¡ç†å‘˜

### é”™è¯¯ 3: "policy already exists"

**åŸå› **ï¼šç­–ç•¥å·²ç»å­˜åœ¨

**è§£å†³**ï¼š
è„šæœ¬ä¼šè‡ªåŠ¨åˆ é™¤æ—§ç­–ç•¥ï¼Œå¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œæ‰‹åŠ¨åˆ é™¤ï¼š

```sql
DROP POLICY IF EXISTS "Users can view their own itineraries" ON itineraries;
DROP POLICY IF EXISTS "Users can insert their own itineraries" ON itineraries;
DROP POLICY IF EXISTS "Users can update their own itineraries" ON itineraries;
DROP POLICY IF EXISTS "Users can delete their own itineraries" ON itineraries;
```

ç„¶åé‡æ–°æ‰§è¡Œ `supabase-setup.sql`

---

## ğŸ“Š æ•°æ®åº“ç»“æ„è¯´æ˜

### è¡¨ï¼šitineraries

| åˆ—å | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | UUID | ä¸»é”®ï¼Œè‡ªåŠ¨ç”Ÿæˆ |
| `user_id` | UUID | ç”¨æˆ·IDï¼Œå¤–é”®å…³è” auth.users |
| `created_at` | TIMESTAMP | åˆ›å»ºæ—¶é—´ï¼Œè‡ªåŠ¨è®¾ç½® |
| `updated_at` | TIMESTAMP | æ›´æ–°æ—¶é—´ï¼Œè‡ªåŠ¨æ›´æ–° |
| `title` | TEXT | è¡Œç¨‹æ ‡é¢˜ |
| `payload` | JSONB | è¡Œç¨‹è¯¦ç»†æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰ |

### ç´¢å¼•

- `idx_itineraries_user_id` - ç”¨æˆ·IDç´¢å¼•ï¼ˆåŠ é€ŸæŸ¥è¯¢ï¼‰
- `idx_itineraries_created_at` - åˆ›å»ºæ—¶é—´ç´¢å¼•ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰

### è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)

æ‰€æœ‰ç­–ç•¥éƒ½åŸºäº `auth.uid() = user_id`ï¼Œç¡®ä¿ï¼š
- âœ… ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è¡Œç¨‹
- âœ… ç”¨æˆ·åªèƒ½åˆ›å»ºè‡ªå·±çš„è¡Œç¨‹
- âœ… ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„è¡Œç¨‹
- âœ… ç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„è¡Œç¨‹

---

## ğŸ§ª æµ‹è¯•æ•°æ®åº“

### æµ‹è¯•æ’å…¥æ•°æ®ï¼ˆéœ€è¦å…ˆç™»å½•ï¼‰

åœ¨åº”ç”¨ä¸­ä½¿ç”¨ "ä¿å­˜åˆ°äº‘ç«¯" åŠŸèƒ½ï¼Œå¦‚æœæˆåŠŸï¼Œè¯´æ˜æ•°æ®åº“é…ç½®æ­£ç¡®ã€‚

### æ‰‹åŠ¨æµ‹è¯•ï¼ˆSQLï¼‰

```sql
-- æŸ¥çœ‹æ‰€æœ‰è¡Œç¨‹ï¼ˆéœ€è¦è®¤è¯ï¼‰
SELECT * FROM itineraries;

-- æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„è¡Œç¨‹ï¼ˆéœ€è¦è®¤è¯ï¼‰
SELECT * FROM itineraries WHERE user_id = auth.uid();
```

---

## ğŸ”„ é‡æ–°è®¾ç½®æ•°æ®åº“

å¦‚æœéœ€è¦å®Œå…¨é‡ç½®æ•°æ®åº“ï¼š

1. **åˆ é™¤è¡¨**ï¼š
   ```sql
   DROP TABLE IF EXISTS itineraries CASCADE;
   ```

2. **é‡æ–°æ‰§è¡Œ** `supabase-setup.sql` è„šæœ¬

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ä¸è¦åˆ é™¤** `auth.users` è¡¨ï¼Œè¿™æ˜¯ Supabase è®¤è¯ç³»ç»Ÿå¿…éœ€çš„
2. **RLS å¿…é¡»å¯ç”¨**ï¼Œå¦åˆ™æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°æ‰€æœ‰æ•°æ®
3. **å¤–é”®çº¦æŸ**ï¼š`user_id` å¿…é¡»å¼•ç”¨ `auth.users(id)`ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§
4. **CASCADE åˆ é™¤**ï¼šåˆ é™¤ç”¨æˆ·æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰è¡Œç¨‹

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] SQL è„šæœ¬æ‰§è¡ŒæˆåŠŸ
- [ ] `itineraries` è¡¨å·²åˆ›å»º
- [ ] æ‰€æœ‰ç´¢å¼•å·²åˆ›å»º
- [ ] RLS å·²å¯ç”¨
- [ ] 4 ä¸ªç­–ç•¥å·²åˆ›å»º
- [ ] åœ¨åº”ç”¨ä¸­æµ‹è¯•ä¿å­˜åŠŸèƒ½æˆåŠŸ

---

## ğŸ†˜ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æ£€æŸ¥ Supabase æ§åˆ¶å°çš„é”™è¯¯æ—¥å¿—
2. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯
3. ç¡®è®¤ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
4. ç¡®è®¤ç”¨æˆ·å·²æ­£ç¡®ç™»å½•

