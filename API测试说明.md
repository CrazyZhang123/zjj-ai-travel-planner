# API æ¥å£æµ‹è¯•æŒ‡å—

## ğŸ” å‰åç«¯æ¥å£éªŒè¯

### 1. ç”Ÿæˆè¡Œç¨‹ API (`/api/plan`)

**æµ‹è¯•æ–¹æ³•**ï¼š

1. **åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•**ï¼š
   - è®¿é—® http://localhost:3000
   - å¡«å†™è¡¨å•
   - ç‚¹å‡» "ç”Ÿæˆè¡Œç¨‹ä¸é¢„ç®—"
   - æŸ¥çœ‹æ˜¯å¦æˆåŠŸç”Ÿæˆè¡Œç¨‹

2. **ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·**ï¼š
   - æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
   - åˆ‡æ¢åˆ° **Network** æ ‡ç­¾
   - ç‚¹å‡» "ç”Ÿæˆè¡Œç¨‹ä¸é¢„ç®—"
   - æŸ¥çœ‹ `/api/plan` è¯·æ±‚ï¼š
     - âœ… Status: 200 OK
     - âœ… Response åŒ…å« `title`, `currency`, `days` ç­‰å­—æ®µ

3. **ä½¿ç”¨ curl æµ‹è¯•**ï¼ˆå¯é€‰ï¼‰ï¼š
   ```bash
   curl -X POST http://localhost:3000/api/plan \
     -H "Content-Type: application/json" \
     -d '{
       "destination": "æ—¥æœ¬ ä¸œäº¬",
       "startDate": "2025-12-01",
       "endDate": "2025-12-05",
       "budget": "10000 CNY",
       "people": 2,
       "prefs": "ç¾é£Ÿã€åŠ¨æ¼«"
     }'
   ```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "title": "ä¸œäº¬5æ—¥æ¸¸",
  "currency": "CNY",
  "total_budget_estimate": 10000,
  "days": [...]
}
```

---

### 2. ä¿å­˜è¡Œç¨‹ API (`/api/save`)

**å‰ç½®æ¡ä»¶**ï¼š
- âœ… ç”¨æˆ·å¿…é¡»å·²ç™»å½•
- âœ… å¿…é¡»æœ‰å·²ç”Ÿæˆçš„è¡Œç¨‹

**æµ‹è¯•æ­¥éª¤**ï¼š

1. **ç™»å½•ç”¨æˆ·**ï¼š
   - ç‚¹å‡»å³ä¸Šè§’ "ç™»å½•/æ³¨å†Œ"
   - è¾“å…¥é‚®ç®±
   - æ£€æŸ¥é‚®ç®±å¹¶ç‚¹å‡»éªŒè¯é“¾æ¥
   - ç¡®è®¤é¡µé¢æ˜¾ç¤º "å·²ç™»å½•ï¼šä½ çš„é‚®ç®±"

2. **ç”Ÿæˆè¡Œç¨‹**ï¼š
   - å¡«å†™è¡¨å•å¹¶ç”Ÿæˆè¡Œç¨‹

3. **ä¿å­˜è¡Œç¨‹**ï¼š
   - ç‚¹å‡» "ä¿å­˜åˆ°äº‘ç«¯"
   - åº”è¯¥çœ‹åˆ° "ä¿å­˜æˆåŠŸï¼è¡Œç¨‹å·²ä¿å­˜åˆ°äº‘ç«¯ã€‚"

4. **éªŒè¯ä¿å­˜**ï¼š
   - åœ¨ Supabase æ§åˆ¶å° â†’ Table Editor â†’ itineraries
   - åº”è¯¥èƒ½çœ‹åˆ°æ–°æ’å…¥çš„è®°å½•

**ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·éªŒè¯**ï¼š

1. æ‰“å¼€ Network æ ‡ç­¾
2. ç‚¹å‡» "ä¿å­˜åˆ°äº‘ç«¯"
3. æŸ¥çœ‹ `/api/save` è¯·æ±‚ï¼š

   **Request Headers** åº”è¯¥åŒ…å«ï¼š
   ```
   Authorization: Bearer eyJhbGc...
   Content-Type: application/json
   ```

   **Request Body** åº”è¯¥åŒ…å«ï¼š
   ```json
   {
     "userId": "uuid-here",
     "title": "ä¸œäº¬5æ—¥æ¸¸",
     "payload": {...}
   }
   ```

   **Response** åº”è¯¥è¿”å›ï¼š
   ```json
   {
     "ok": true,
     "data": {
       "id": "uuid",
       "user_id": "uuid",
       "title": "ä¸œäº¬5æ—¥æ¸¸",
       ...
     },
     "message": "Itinerary saved successfully"
   }
   ```

---

## ğŸ› å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### é”™è¯¯ 1: "Missing DASHSCOPE_API_KEY"

**åŸå› **ï¼šç¯å¢ƒå˜é‡æœªé…ç½®

**è§£å†³**ï¼š
1. æ£€æŸ¥ `.env.local` æ–‡ä»¶æ˜¯å¦å­˜åœ¨
2. ç¡®è®¤ `DASHSCOPE_API_KEY` å·²é…ç½®
3. é‡å¯å¼€å‘æœåŠ¡å™¨

---

### é”™è¯¯ 2: "Dashscope API error" (403 Forbidden)

**åŸå› **ï¼šAPI Key æ— æ•ˆæˆ–è´¦æˆ·æƒé™é—®é¢˜

**è§£å†³**ï¼š
1. æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ç™¾ç‚¼æœåŠ¡å·²å¼€é€š
3. æ£€æŸ¥è´¦æˆ·ä½™é¢
4. å°è¯•æ›´æ¢æ¨¡å‹ï¼ˆqwen-turbo â†’ qwen-plusï¼‰

---

### é”™è¯¯ 3: "Missing or invalid authorization token"

**åŸå› **ï¼šç”¨æˆ·æœªç™»å½•æˆ– token è¿‡æœŸ

**è§£å†³**ï¼š
1. ç¡®ä¿ç”¨æˆ·å·²ç™»å½•
2. å¦‚æœå·²ç™»å½•ï¼Œå°è¯•é‡æ–°ç™»å½•
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰è®¤è¯é”™è¯¯

---

### é”™è¯¯ 4: "new row violates row-level security policy"

**åŸå› **ï¼šRLS ç­–ç•¥é…ç½®é”™è¯¯

**è§£å†³**ï¼š
1. åœ¨ Supabase æ‰§è¡Œ `supabase-setup.sql` è„šæœ¬
2. ç¡®è®¤ç­–ç•¥å·²æ­£ç¡®åˆ›å»º
3. ç¡®è®¤ `user_id` ä¸å½“å‰ç™»å½•ç”¨æˆ·åŒ¹é…

---

### é”™è¯¯ 5: "User ID mismatch"

**åŸå› **ï¼šå‰ç«¯ä¼ é€’çš„ userId ä¸è®¤è¯ç”¨æˆ·ä¸åŒ¹é…

**è§£å†³**ï¼š
- è¿™é€šå¸¸ä¸ä¼šå‘ç”Ÿï¼Œå¦‚æœå‡ºç°è¯´æ˜ä»£ç æœ‰ bug
- æ£€æŸ¥ `app/page.tsx` ä¸­çš„ save å‡½æ•°

---

## âœ… æ¥å£éªŒè¯æ¸…å•

### ç”Ÿæˆè¡Œç¨‹ API
- [ ] è¯·æ±‚æˆåŠŸè¿”å› 200
- [ ] å“åº”åŒ…å« `title` å­—æ®µ
- [ ] å“åº”åŒ…å« `days` æ•°ç»„
- [ ] å“åº”åŒ…å« `currency` å’Œ `total_budget_estimate`

### ä¿å­˜è¡Œç¨‹ API
- [ ] æœªç™»å½•æ—¶æç¤º "è¯·å…ˆç™»å½•"
- [ ] å·²ç™»å½•æ—¶è¯·æ±‚åŒ…å« Authorization header
- [ ] ä¿å­˜æˆåŠŸè¿”å› 200 å’ŒæˆåŠŸæ¶ˆæ¯
- [ ] æ•°æ®æ­£ç¡®ä¿å­˜åˆ° Supabase
- [ ] é”™è¯¯æ—¶è¿”å›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### è®¤è¯æµç¨‹
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] ç™»å½•åæ˜¾ç¤ºç”¨æˆ·é‚®ç®±
- [ ] é€€å‡ºç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] Session æ­£ç¡®ä¼ é€’åˆ° API

---

## ğŸ§ª å®Œæ•´æµ‹è¯•æµç¨‹

1. **å¯åŠ¨æœåŠ¡å™¨**ï¼š
   ```bash
   npm run dev
   ```

2. **æµ‹è¯•ç”Ÿæˆè¡Œç¨‹**ï¼š
   - è®¿é—® http://localhost:3000
   - å¡«å†™è¡¨å•
   - ç”Ÿæˆè¡Œç¨‹
   - âœ… éªŒè¯è¡Œç¨‹æ˜¾ç¤ºæ­£ç¡®

3. **æµ‹è¯•ç™»å½•**ï¼š
   - ç‚¹å‡» "ç™»å½•/æ³¨å†Œ"
   - è¾“å…¥é‚®ç®±
   - æ£€æŸ¥é‚®ç®±å¹¶éªŒè¯
   - âœ… éªŒè¯æ˜¾ç¤º "å·²ç™»å½•"

4. **æµ‹è¯•ä¿å­˜**ï¼š
   - ç‚¹å‡» "ä¿å­˜åˆ°äº‘ç«¯"
   - âœ… éªŒè¯æç¤º "ä¿å­˜æˆåŠŸ"
   - åœ¨ Supabase éªŒè¯æ•°æ®å·²ä¿å­˜

5. **æµ‹è¯•é”™è¯¯å¤„ç†**ï¼š
   - æœªç™»å½•æ—¶å°è¯•ä¿å­˜ â†’ åº”è¯¥æç¤ºç™»å½•
   - æœªç”Ÿæˆè¡Œç¨‹æ—¶å°è¯•ä¿å­˜ â†’ åº”è¯¥æç¤ºå…ˆç”Ÿæˆ

---

## ğŸ“Š æ¥å£è§„èŒƒ

### POST /api/plan

**Request**:
```typescript
{
  destination: string;
  startDate: string;  // YYYY-MM-DD
  endDate: string;    // YYYY-MM-DD
  budget: string;     // e.g. "10000 CNY"
  people: number;
  prefs: string;
}
```

**Response (Success)**:
```typescript
{
  title: string;
  currency: string;
  total_budget_estimate: number;
  days: Array<{
    date: string;
    city: string;
    activities: Array<...>;
    hotel?: {...};
    meals?: Array<...>;
    ...
  }>;
}
```

**Response (Error)**:
```typescript
{
  error: string;
  detail?: string;
  status?: number;
}
```

---

### POST /api/save

**Request Headers**:
```
Authorization: Bearer <jwt-token>
Content-Type: application/json
```

**Request Body**:
```typescript
{
  userId: string;  // UUID
  title: string;
  payload: object;  // å®Œæ•´çš„è¡Œç¨‹æ•°æ®
}
```

**Response (Success)**:
```typescript
{
  ok: true;
  data: {
    id: string;
    user_id: string;
    title: string;
    payload: object;
    created_at: string;
    updated_at: string;
  };
  message: string;
}
```

**Response (Error)**:
```typescript
{
  error: string;
  details?: string;
}
```

---

## ğŸ¯ æ€§èƒ½æ£€æŸ¥

- âœ… API å“åº”æ—¶é—´ < 3ç§’ï¼ˆç”Ÿæˆè¡Œç¨‹ï¼‰
- âœ… API å“åº”æ—¶é—´ < 1ç§’ï¼ˆä¿å­˜è¡Œç¨‹ï¼‰
- âœ… é”™è¯¯å¤„ç†å“åº”æ¸…æ™°
- âœ… å‰ç«¯é”™è¯¯æç¤ºå‹å¥½

---

å®Œæˆä»¥ä¸Šæµ‹è¯•åï¼Œä½ çš„å‰åç«¯æ¥å£åº”è¯¥å®Œå…¨æ­£å¸¸å·¥ä½œï¼ğŸ‰

